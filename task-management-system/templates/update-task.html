<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Cập nhật Task</title>
</head>
<body>
    <h2>Cập nhật Task</h2>
    <form id="updateTaskForm">
        <label>Tiêu đề:</label><br>
        <input type="text" id="title" required><br>

        <label>Mô tả:</label><br>
        <textarea id="description" required></textarea><br>

        <label>Trạng thái:</label><br>
        <select id="status" required>
            <option value="pending">Pending</option>
            <option value="completed">Completed</option>
        </select><br>

        <label>Ngày đến hạn:</label><br>
        <input type="date" id="dueDate" required><br>

        <label>Danh mục:</label><br>
        <input type="text" id="category" required><br><br>

        <button type="submit">Cập nhật</button>
    </form>

    <script>
        const taskId = new URLSearchParams(window.location.search).get("id");
        const token = localStorage.getItem("token");

        if (!taskId || !token) {
            alert("Thiếu thông tin cần thiết!");
            window.location.href = "/tasks-page";
        }

        // Fetch task details
        fetch("/tasks", {
            headers: {
                "Authorization": `Bearer ${token}`
            }
        })
        .then(res => {
            if (!res.ok) throw new Error("Không thể tải danh sách task");
            return res.json();
        })
        .then(data => {
            const task = data.find(t => t.id == taskId); // ← sử dụng `id` thay vì `ID`
            if (task) {
                document.getElementById("title").value = task.title;
                document.getElementById("description").value = task.description;
                document.getElementById("status").value = task.status;
                document.getElementById("dueDate").value = task.due_date;
                document.getElementById("category").value = task.category;
            } else {
                alert("Task không tồn tại!");
                window.location.href = "/tasks-page";
            }
        })
        .catch(err => {
            console.error(err);
            alert("Có lỗi xảy ra khi tải dữ liệu task!");
            window.location.href = "/tasks-page";
        });

        // Handle task update
        document.getElementById("updateTaskForm").addEventListener("submit", function(e) {
            e.preventDefault();

            const taskData = {
                title: document.getElementById("title").value,
                description: document.getElementById("description").value,
                status: document.getElementById("status").value,
                due_date: document.getElementById("dueDate").value,
                category: document.getElementById("category").value
            };

            fetch(`/tasks/${taskId}`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify(taskData)
            })
            .then(res => {
                if (!res.ok) {
                    throw new Error("Cập nhật không thành công");
                }
                return res.json();
            })
            .then(() => {
                alert("Task cập nhật thành công!");
                window.location.href = "/tasks-page";
            })
            .catch(err => {
                console.error(err);
                alert("Có lỗi xảy ra khi cập nhật task!");
            });
        });
    </script>
</body>
</html>
